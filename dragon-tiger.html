<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üêâ Dragon Tiger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial}
.header{text-align:center;padding:15px;font-size:26px;font-weight:bold}

.card{background:#1a1a1a;margin:12px;padding:15px;border-radius:14px}
.center{text-align:center}
.timer{font-size:22px;color:#ff4d6d;margin-top:6px}

.row{display:flex;gap:10px}
.box{flex:1;padding:20px;border-radius:12px;text-align:center;font-size:22px;font-weight:bold}
.dragon{background:#2196f3}
.tiger{background:#ff5722}

.bet-btns button{flex:1;background:#333}
.bet-btns button.active{
  outline:3px solid #00e5ff;
  transform:scale(1.05)
}

input{width:100%;padding:14px;border-radius:10px;border:none;margin-top:10px}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:10px;font-size:16px;font-weight:bold;background:#2196f3;color:#fff}
button:disabled{opacity:.5}

.cardInner{
  transition:.6s;
  transform-style:preserve-3d;
}
.flip{transform:rotateY(360deg)}

.history{font-size:14px;line-height:1.6;margin-top:6px}

.popup{
  position:fixed;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);z-index:99
}
.popup div{
  background:#1e1e1e;
  padding:25px;
  border-radius:14px;
  font-size:18px;
  text-align:center
}
.win{color:#4caf50}
.lose{color:#ff5252}
</style>
</head>

<body>

<div class="header">üêâ DRAGON ‚Ä¢ TIGER</div>

<div class="card center">
  <div id="info">Wallet: ‚Çπ0</div>
  <div class="timer" id="timer">25s</div>
</div>

<div class="card">
  <div class="row">
    <div class="box dragon">
      <div id="dragonCard" class="cardInner">üêâ <span id="dragonVal">?</span></div>
    </div>
    <div class="box tiger">
      <div id="tigerCard" class="cardInner">üêÖ <span id="tigerVal">?</span></div>
    </div>
  </div>

  <input id="amount" type="number" min="1" placeholder="Min ‚Çπ1">

  <div class="row bet-btns">
    <button id="btnDragon" onclick="selectSide('DRAGON')">DRAGON</button>
    <button id="btnTiger" onclick="selectSide('TIGER')">TIGER</button>
  </div>

  <button id="betBtn" onclick="placeBet()">PLACE BET</button>
</div>

<div class="card">
  <b>Last 10 Games</b>
  <div class="history" id="last10"></div>
</div>

<div class="card">
  <b>My Bets</b>
  <div class="history" id="myBets"></div>
</div>

<div class="popup" id="popup"><div id="popupText"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db = getFirestore(app);

/* USER */
const email = localStorage.getItem("userEmail");
let uid="", wallet=0;

/* LOAD WALLET */
async function loadWallet(){
  const q=query(collection(db,"users"),where("email","==",email));
  const s=await getDocs(q);
  s.forEach(d=>{uid=d.id;wallet=d.data().balance||0});
  render();
}

/* ---------- STATE (PERSIST) ---------- */
const KEY="DT_STATE";

let time=25, phase="BET", selected=null;
let bets=[], last10=[];
let total={DRAGON:0,TIGER:0};

function saveState(){
  localStorage.setItem(KEY,JSON.stringify({
    time,phase,selected,bets,last10,total
  }));
}

function loadState(){
  const d=JSON.parse(localStorage.getItem(KEY)||"{}");
  time=d.time??25;
  phase=d.phase??"BET";
  selected=d.selected??null;
  bets=d.bets??[];
  last10=d.last10??[];
  total=d.total??{DRAGON:0,TIGER:0};
}

/* UI */
function render(){
  info.innerText=`Wallet: ‚Çπ${wallet.toFixed(2)}`;
  timer.innerText=time+"s";
  betBtn.disabled=phase!=="BET";

  last10.innerHTML = last10.map(x=>x).join("<br>");
  myBets.innerHTML = bets.map(b=>`${b.side} ‚Çπ${b.amt} ‚Üí ${b.res}`).join("<br>");

  document.querySelectorAll(".bet-btns button").forEach(b=>b.classList.remove("active"));
  if(selected){
    document.getElementById("btn"+selected.charAt(0)+selected.slice(1).toLowerCase()).classList.add("active");
  }
}

function popupMsg(msg,cls=""){
  popupText.className=cls;
  popupText.innerText=msg;
  popup.style.display="flex";
  setTimeout(()=>popup.style.display="none",1500);
}

/* SELECT */
window.selectSide=s=>{
  if(phase!=="BET")return;
  selected=s;
  saveState();
  render();
};

/* PLACE BET */
window.placeBet=async()=>{
  const a=+amount.value;
  if(!selected||a<1||a>wallet)return;

  wallet-=a;
  await updateDoc(doc(db,"users",uid),{balance:wallet});

  bets.unshift({side:selected,amt:a,res:"PENDING"});
  total[selected]+=a;

  popupMsg("BET PLACED");
  saveState();
  render();
};

/* GAME LOOP */
setInterval(()=>{
  if(time>0) time--;
  else{
    if(phase==="BET"){phase="LOCK";time=5}
    else if(phase==="LOCK"){showResult();phase="RESULT";time=5}
    else{
      phase="BET";time=25;selected=null;
      total={DRAGON:0,TIGER:0};
      dragonVal.innerText="?";
      tigerVal.innerText="?";
    }
  }
  saveState();
  render();
},1000);

/* RESULT (LOWER BET WINS) */
async function showResult(){
  dragonCard.classList.add("flip");
  tigerCard.classList.add("flip");

  let d=Math.floor(Math.random()*13)+1;
  let t=Math.floor(Math.random()*13)+1;

  dragonVal.innerText=d;
  tigerVal.innerText=t;

  let win;
  if(total.DRAGON===total.TIGER){
    win = d<t ? "DRAGON" : "TIGER";
  }else{
    win = total.DRAGON < total.TIGER ? "DRAGON" : "TIGER";
  }

  last10.unshift("WIN ‚Üí "+win);
  last10=last10.slice(0,10);

  for(let b of bets){
    if(b.res==="PENDING"){
      if(b.side===win){
        let w=b.amt*2;
        wallet+=w;
        await updateDoc(doc(db,"users",uid),{balance:wallet});
        b.res="WIN ‚Çπ"+w;
        popupMsg("YOU WIN ‚Çπ"+w,"win");
      }else{
        b.res="LOSS";
        popupMsg("YOU LOST","lose");
      }
    }
  }
}

/* INIT */
loadState();
loadWallet();
render();
</script>

</body>
</html>
