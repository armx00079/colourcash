<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dice Roll</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:radial-gradient(circle at top,#0b1c2d,#030b14);
  color:#fff;
  text-align:center;
}

#walletBox{
  position:fixed;
  top:15px;
  right:15px;
  background:#000;
  padding:8px 14px;
  border-radius:20px;
  font-weight:bold;
}

.container{
  margin-top:120px;
}

.dice{
  font-size:120px;
  margin:20px 0;
  transition:transform .4s;
}

.roll{
  animation: shake .4s infinite;
}

@keyframes shake{
  0%{transform:rotate(0deg)}
  25%{transform:rotate(10deg)}
  50%{transform:rotate(-10deg)}
  75%{transform:rotate(10deg)}
  100%{transform:rotate(0deg)}
}

input{
  width:220px;
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:16px;
  margin-bottom:15px;
}

button{
  width:240px;
  padding:14px;
  border-radius:25px;
  border:none;
  font-size:18px;
  background:linear-gradient(135deg,#ffcf6a,#ff9f1a);
  font-weight:bold;
}

.history{
  margin-top:30px;
  display:flex;
  justify-content:center;
  gap:8px;
}

.history span{
  width:32px;
  height:32px;
  background:#222;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
}
.popup-box{
  background:#ffd56a;
  color:#000;
  padding:30px 40px;
  border-radius:20px;
  font-size:24px;
  font-weight:bold;
}
</style>
</head>

<body>

<div id="walletBox">üí∞ ‚Çπ<span id="walletAmt">0</span></div>

<div class="container">
  <h2>DICE ROLL</h2>
  <div class="dice" id="dice">üé≤</div>

  <input type="number" id="betAmount" placeholder="Enter Bet Amount">
  <br>
  <button onclick="rollDice()">ROLL DICE</button>

  <div class="history" id="history"></div>
</div>

<div class="popup" id="popup">
  <div class="popup-box" id="popupText"></div>
</div>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  where, 
  getDocs, 
  doc, 
  updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain: "colourcash-ea60e.firebaseapp.com",
  projectId: "colourcash-ea60e",
  storageBucket: "colourcash-ea60e.firebasestorage.app",
  messagingSenderId: "403688058646",
  appId: "1:403688058646:web:f1753360471528f275ea37"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== USER (TESTING) ===== */
const userEmail = "samxj525@gmail.com"; // üî¥ SAME AS FIREBASE

let wallet = 0;
let userDocId = "";

/* ===== LOAD WALLET ===== */
async function loadWallet(){
  const q = query(
    collection(db,"users"),
    where("email","==",userEmail)
  );

  const snap = await getDocs(q);

  snap.forEach(d=>{
    userDocId = d.id;
    wallet = Number(d.data().balance || 0);
    walletAmt.innerText = wallet;
  });
}

/* ===== UPDATE WALLET ===== */
async function updateWallet(){
  await updateDoc(doc(db,"users",userDocId),{
    balance: wallet
  });
  walletAmt.innerText = wallet;
}

/* ===== DICE GAME ===== */
const diceIcons = ["‚öÄ","‚öÅ","‚öÇ","‚öÉ","‚öÑ","‚öÖ"];
const diceEl = document.getElementById("dice");

window.rollDice = async function(){
  const bet = Number(betAmount.value);

  if(!bet || bet<=0) return alert("Enter valid bet");
  if(bet>wallet) return alert("Insufficient balance");

  wallet -= bet;
  await updateWallet();

  diceEl.classList.add("roll");

  setTimeout(async ()=>{
    diceEl.classList.remove("roll");

    const roll = Math.floor(Math.random()*6)+1;
    diceEl.innerText = diceIcons[roll-1];

    let win = false;
    let winAmount = 0;

    if(roll >= 4){ // 4,5,6 = WIN
      win = true;
      winAmount = bet * 2;
      wallet += winAmount;
      await updateWallet();
    }

    showPopup(win ? `üéâ YOU WIN ‚Çπ${winAmount}` : "‚ùå YOU LOST");

    addHistory(roll);

  },1500);
}

/* ===== POPUP ===== */
function showPopup(text){
  popupText.innerText = text;
  popup.style.display = "flex";
  setTimeout(()=>popup.style.display="none",2000);
}

/* ===== HISTORY ===== */
function addHistory(num){
  const h = document.createElement("span");
  h.innerText = num;
  history.prepend(h);
  if(history.children.length>6){
    history.lastChild.remove();
  }
}

/* INIT */
loadWallet();

</script>

</body>
</html>
