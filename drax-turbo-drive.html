<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üöó Drax Turbo Drive</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;font-family:Arial;
  background:linear-gradient(135deg,#ff4fd8,#8f2bff);
  color:#fff;text-align:center
}
.header{padding:14px;font-size:22px;font-weight:bold}
.wallet{
  margin-top:8px;background:rgba(0,0,0,.35);
  display:inline-block;padding:6px 18px;border-radius:20px
}
.multis{display:flex;justify-content:center;gap:10px;margin:12px 0}
.multi{padding:8px 16px;background:#000;border-radius:14px;font-weight:bold}
.track{background:#14001f;margin:14px;padding:14px;border-radius:16px}
.road{display:flex;align-items:center;margin:18px 0}
.car{font-size:32px;transition:transform 1.2s ease}
.line{
  flex:1;height:6px;margin-left:10px;
  background:repeating-linear-gradient(90deg,yellow 0 14px,black 14px 28px);
  border-radius:6px
}
.select{display:flex;gap:10px;padding:0 14px}
.sel{
  flex:1;padding:12px 0;border-radius:16px;
  background:#2b003d;cursor:pointer;font-weight:bold
}
.sel.active{background:#ff66e3;color:#000;transform:scale(1.05)}
.logo{width:42px;height:42px;object-fit:contain;margin-bottom:6px}
.bottom-bar{display:flex;flex-direction:column;gap:14px;margin:14px}
.bottom-bar input,
.bottom-bar button{
  width:100%;padding:14px;border:none;border-radius:30px;font-size:16px
}
.bottom-bar button{background:#ff4fd8;font-size:18px;font-weight:bold}
.history{
  background:#14001f;margin:14px;padding:12px;
  border-radius:16px;font-size:14px;text-align:left
}
.history h3{text-align:center;margin:0 0 8px}
.history div{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.1)}
.popup{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
.popup div{
  background:#fff;color:#000;padding:24px 40px;
  border-radius:20px;font-size:22px;font-weight:bold
}
</style>
</head>

<body>

<div class="header">
 üöó DRAX TURBO DRIVE
 <div class="wallet">‚Çπ <span id="wallet">0</span></div>
</div>

<div class="multis">
 <div class="multi">Mercedes 3x</div>
 <div class="multi">Audi 3x</div>
 <div class="multi">BMW 5x</div>
</div>

<div class="track">
 <div class="road"><div class="car" id="car-mer">üöó</div><div class="line"></div></div>
 <div class="road"><div class="car" id="car-audi">üöô</div><div class="line"></div></div>
 <div class="road"><div class="car" id="car-bmw">üöï</div><div class="line"></div></div>
</div>

<div class="select">
 <div class="sel" onclick="selectCar('mer',this)">
  <img src="images/mercedes.png" class="logo"><div>Mercedes</div>
 </div>
 <div class="sel" onclick="selectCar('audi',this)">
  <img src="images/audi.png" class="logo"><div>Audi</div>
 </div>
 <div class="sel" onclick="selectCar('bmw',this)">
  <img src="images/bmw.png" class="logo"><div>BMW</div>
 </div>
</div>

<div class="bottom-bar">
 <input id="betInput" type="number" value="100">
 <button id="startBtn" onclick="startRace()">START RACE</button>
</div>

<div class="history">
 <h3>MY BETS</h3>
 <div id="historyBox">No bets yet</div>
</div>

<div class="popup" id="popup"><div id="popupText"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,collection,query,where,
  getDocs,getDoc,doc,updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const walletSpan = document.getElementById("wallet");

const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db = getFirestore(app);

const userEmail = localStorage.getItem("userEmail");
let uid="", wallet=0;
let HOUSE_EDGE = 0.25;

async function loadHouseEdge(){
  const ref = doc(db,"settings","houseEdge");
  const snap = await getDoc(ref);
  if(snap.exists()){
    HOUSE_EDGE = snap.data().draxTurbo || 0.25;
  }
}

async function loadWallet(){
  const q = query(collection(db,"users"), where("email","==",userEmail));
  const snap = await getDocs(q);
  snap.forEach(d=>{
    uid = d.id;
    wallet = Number(d.data().balance || 0);
  });
  updateWallet();
}

async function saveWallet(){
  if(uid){
    await updateDoc(doc(db,"users",uid),{ balance: wallet });
  }
}

(async ()=>{
  await loadHouseEdge();
  await loadWallet();
})();

let selected="";
let history=[];
let raceRunning=false;
let lastResult = localStorage.getItem("lastResult") || "LOSS";

const cars={
 mer:{el:"car-mer",pay:3},
 audi:{el:"car-audi",pay:3},
 bmw:{el:"car-bmw",pay:5}
};

window.selectCar=(c,el)=>{
 if(raceRunning) return;
 selected=c;
 document.querySelectorAll(".sel").forEach(x=>x.classList.remove("active"));
 el.classList.add("active");
};

window.startRace=async ()=>{
 if(raceRunning) return;
 const bet=Number(betInput.value);
 if(!selected) return alert("Select car");
 if(bet<=0||bet>wallet) return alert("Low balance");

 raceRunning=true;
 startBtn.disabled=true;

 wallet-=bet;
 await saveWallet();
 updateWallet();

 Object.values(cars).forEach(c=>{
  document.getElementById(c.el).style.transform="translateX(0)";
 });

 const winner=decideWinner();

 setTimeout(()=>{
  document.getElementById(cars[winner].el)
   .style.transform="translateX(240px)";
 },200);

 setTimeout(async ()=>{
  if(winner===selected){
    const win=bet*cars[winner].pay;
    wallet+=win;
    await saveWallet();
    addHistory(`‚úÖ ${winner.toUpperCase()} +‚Çπ${win}`);
    showPopup(`üéâ WIN ‚Çπ${win}`);
  }else{
    addHistory(`‚ùå ${selected.toUpperCase()} -‚Çπ${bet}`);
    showPopup("‚ùå LOST");
  }
  updateWallet();
  raceRunning=false;
  startBtn.disabled=false;
 },1600);
};

function decideWinner(){
  if(Math.random() < HOUSE_EDGE){
    return selected;
  }else{
    return getOtherCar();
  }
}

function getOtherCar(){
 return Object.keys(cars).filter(c=>c!==selected)
  [Math.floor(Math.random()*2)];
}

function addHistory(t){
 history.unshift(t);
 history=history.slice(0,10);
 historyBox.innerHTML=history.join("<br>");
}
function updateWallet(){
 walletSpan.innerText=wallet;
}
function showPopup(t){
 popupText.innerText=t;
 popup.style.display="flex";
 setTimeout(()=>popup.style.display="none",1500);
}
</script>

</body>
</html>
