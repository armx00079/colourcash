<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>âš¡ Fate Shift</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:radial-gradient(circle at top,#3a005f,#12001f);
  color:#fff;
  text-align:center;
}

/* HEADER */
.header{
  padding:14px;
  font-size:22px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.wallet{
  background:rgba(0,0,0,.35);
  padding:6px 14px;
  border-radius:20px;
  font-size:16px;
}

/* CARD */
.card{
  margin:18px;
  padding:20px;
  border-radius:20px;
  background:linear-gradient(180deg,#24003a,#140020);
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

.multiplier{
  font-size:46px;
  font-weight:bold;
  margin-bottom:14px;
}

/* BAR */
.bar{
  height:10px;
  background:#333;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:18px;
}
.bar-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#ff5fd8,#ff9f43);
}

/* INPUT */
input{
  width:100%;
  padding:14px;
  border:none;
  border-radius:30px;
  font-size:18px;
  text-align:center;
  margin-bottom:14px;
}

/* BUTTONS */
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:30px;
  font-size:18px;
  font-weight:bold;
  margin-top:12px;
  cursor:pointer;
}
.start{background:#ff5fd8;color:#000}
.start:active{
  transform:scale(0.97);
  box-shadow:0 0 18px rgba(255,95,216,.9);
}
.shift{background:#6d3b85;color:#000}
.shift:disabled{opacity:.5}

/* STATUS */
.status{
  margin-top:10px;
  opacity:.85;
}

/* MY BETS */
.bets-box{
  margin:18px;
  background:#1a0126;
  border-radius:16px;
  padding:14px;
  text-align:left;
}
.bets-box h3{
  margin:0 0 8px;
  font-size:16px;
}
.bet-row{
  font-size:14px;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.win{color:#4caf50}
.lose{color:#ff5252}
</style>
</head>

<body>

<div class="header">
  âš¡ FATE SHIFT
  <div class="wallet">â‚¹ <span id="wallet">0.00</span></div>
</div>

<div class="card">
  <div class="multiplier"><span id="multi">1.00</span>x</div>

  <div class="bar">
    <div class="bar-fill" id="bar"></div>
  </div>

  <input id="betInput" type="number" min="10" value="100">

  <button class="btn start" id="startBtn">START CHARGE</button>
  <button class="btn shift" id="shiftBtn" disabled>SHIFT</button>

  <div class="status" id="status">Ready</div>
</div>

<div class="bets-box">
  <h3>MY BETS</h3>
  <div id="bets">No bets yet</div>
</div>

<!-- ðŸ”¥ FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain: "colourcash-ea60e.firebaseapp.com",
  projectId: "colourcash-ea60e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* WALLET */
const userEmail = localStorage.getItem("userEmail");
let userDocId="", balance=0;

/* GAME STATE */
let running=false;
let rafId=null;
let multiplier=1;
let barWidth=0;
let bet=0;
let crashPoint=0;
let rounds = Number(localStorage.getItem("fs_rounds")||0);
let bets = JSON.parse(localStorage.getItem("fs_bets")||"[]");

/* LOAD WALLET */
async function loadWallet(){
  const snap = await getDocs(
    query(collection(db,"users"), where("email","==",userEmail))
  );
  snap.forEach(d=>{
    userDocId=d.id;
    balance=d.data().balance||0;
  });
  wallet.innerText=balance.toFixed(2);
}
loadWallet();

/* RISK ENGINE */
function getCrash(){
  let base = 1.6 + Math.random()*0.6; // 1.6â€“2.2
  let betRisk = Math.min(bet/1000,1)*0.7;
  let houseBias = Math.random()<0.65 ? 0.4 : -0.15;

  if(rounds===0 && bet<=300) base+=0.5;

  let crash = base - betRisk - houseBias;
  return Math.max(1.25, Math.min(crash,2.3));
}

/* START */
startBtn.onclick = async ()=>{
  bet = Number(betInput.value);
  if(bet<10 || bet>balance) return alert("Invalid bet");

  balance-=bet;
  await updateDoc(doc(db,"users",userDocId),{balance});
  wallet.innerText=balance.toFixed(2);

  multiplier=1;
  barWidth=0;
  crashPoint=getCrash();

  running=true;
  startBtn.disabled=true;
  shiftBtn.disabled=false;
  status.innerText="Charging...";

  function animate(){
    if(!running) return;
    multiplier+=0.03+Math.random()*0.02;
    barWidth+=2.5;

    multi.innerText=multiplier.toFixed(2);
    bar.style.width=Math.min(barWidth,100)+"%";

    if(multiplier>=crashPoint){
      crash();
      return;
    }
    rafId=requestAnimationFrame(animate);
  }
  animate();
};

/* SHIFT */
shiftBtn.onclick = async ()=>{
  if(!running) return;
  running=false;

  let win = bet*multiplier;
  balance+=win;
  await updateDoc(doc(db,"users",userDocId),{balance});
  wallet.innerText=balance.toFixed(2);

  addBet(`WIN â‚¹${bet} â†’ â‚¹${win.toFixed(2)}`,"win");
  end("ðŸŽ‰ You Win");
};

/* CRASH */
function crash(){
  running=false;
  addBet(`LOSS â‚¹${bet}`,"lose");
  end("ðŸ’¥ Shift Failed");
}

/* END */
function end(msg){
  status.innerText=msg;
  startBtn.disabled=false;
  shiftBtn.disabled=true;
  rounds++;
  localStorage.setItem("fs_rounds",rounds);
}

/* BET HISTORY */
function addBet(t,c){
  bets.unshift({t,c});
  bets=bets.slice(0,10);
  localStorage.setItem("fs_bets",JSON.stringify(bets));
  render();
}
function render(){
  betsDiv.innerHTML = bets.length
   ? bets.map(b=>`<div class="bet-row ${b.c}">${b.t}</div>`).join("")
   : "No bets yet";
}
window.addEventListener("load",render);
</script>

</body>
</html>
