<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>âš¡ Fate Shift</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:radial-gradient(circle at top,#3a005f,#12001f);
  color:#fff;
  text-align:center;
}
.header{
  padding:14px;
  font-size:22px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.wallet{
  background:rgba(0,0,0,.35);
  padding:6px 14px;
  border-radius:20px;
}
.card{
  margin:18px;
  padding:20px;
  border-radius:20px;
  background:linear-gradient(180deg,#24003a,#140020);
}
.multiplier{
  font-size:46px;
  font-weight:bold;
  margin-bottom:14px;
}
.bar{
  height:10px;
  background:#333;
  border-radius:10px;
  overflow:hidden;
}
.bar-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#ff5fd8,#ff9f43);
}
input{
  width:100%;
  padding:14px;
  border:none;
  border-radius:30px;
  font-size:18px;
  text-align:center;
  margin:12px 0;
}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:30px;
  font-size:18px;
  font-weight:bold;
  margin-top:14px;
  cursor:pointer;
}
.start{background:#ff5fd8;color:#000}
.start.running{box-shadow:0 0 25px #ff5fd8}
.shift{background:#6d3b85}
.shift:disabled{opacity:.5}
.status{margin-top:12px}
.bets-box{
  margin:18px;
  background:#1a0126;
  border-radius:16px;
  padding:14px;
  text-align:left;
}
.bet-row{font-size:14px;padding:6px 0}
.win{color:#4caf50}
.lose{color:#ff5252}
</style>
</head>

<body>

<div class="header">
 âš¡ FATE SHIFT
 <div class="wallet">â‚¹ <span id="wallet">0.00</span></div>
</div>

<div class="card">
  <div class="multiplier"><span id="multi">1.00</span>x</div>

  <div class="bar">
    <div class="bar-fill" id="bar"></div>
  </div>

  <input id="betInput" type="number" value="100">
  <input id="autoInput" type="number" step="0.01" placeholder="Auto Shift (e.g. 1.10)">

  <button class="btn start" id="startBtn">START CHARGE</button>
  <button class="btn shift" id="shiftBtn" disabled>SHIFT</button>

  <div class="status" id="status">Ready</div>
</div>

<div class="bets-box">
 <b>MY BETS</b>
 <div id="bets">No bets yet</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db = getFirestore(app);

/* DOM */
const startBtn = document.getElementById("startBtn");
const shiftBtn = document.getElementById("shiftBtn");
const betInput = document.getElementById("betInput");
const autoInput = document.getElementById("autoInput");
const walletEl = document.getElementById("wallet");
const multiEl = document.getElementById("multi");
const barEl = document.getElementById("bar");
const betsEl = document.getElementById("bets");
const statusEl = document.getElementById("status");

/* STATE */
let running=false;
let multiplier=1;
let bar=0;
let bet=0;
let crash=0;
let balance=0;
let docId="";
let autoShift=0;

/* LOAD HISTORY */
let history = JSON.parse(localStorage.getItem("FS_HISTORY")||"[]");
renderHistory();

/* LOAD WALLET */
const email = localStorage.getItem("userEmail");
const snap = await getDocs(
  query(collection(db,"users"), where("email","==",email))
);
snap.forEach(d=>{
  docId=d.id;
  balance=d.data().balance||0;
});
walletEl.innerText = balance.toFixed(2);

/* CRASH POINT (MAX â‰ˆ 2.2x) */
function crashPoint(){
  return 1.45 + Math.random()*0.75;
}

/* OWNER EDGE */
function shouldAutoWin(){
  let loseChance = 0.65;              // base loss
  loseChance += Math.min(bet/1000,1)*0.2; // high bet = more loss
  return Math.random() > loseChance;
}

/* START */
startBtn.onclick = async ()=>{
  if(running) return;

  bet = +betInput.value;
  autoShift = +autoInput.value || 0;

  if(bet < 10 || bet > balance){
    alert("Invalid bet");
    return;
  }

  balance -= bet;
  await updateDoc(doc(db,"users",docId),{balance});
  walletEl.innerText = balance.toFixed(2);

  multiplier = 1;
  bar = 0;
  crash = crashPoint();

  running = true;
  startBtn.disabled = true;
  shiftBtn.disabled = false;
  startBtn.classList.add("running");
  statusEl.innerText = "Charging...";

  requestAnimationFrame(loop);
};

/* LOOP */
function loop(){
  if(!running) return;

  multiplier += 0.025 + Math.random()*0.02;
  bar += 2 + Math.random()*1;

  multiEl.innerText = multiplier.toFixed(2);
  barEl.style.width = Math.min(bar,100)+"%";

  // RANDOM EARLY CRASH (OWNER SAFE)
  if(Math.random() < 0.02){
    end(false);
    return;
  }

  // AUTO SHIFT (NOT GUARANTEED)
  if(autoShift > 1 && multiplier >= autoShift){
    if(shouldAutoWin()){
      end(true);
    }else{
      end(false);
    }
    return;
  }

  // HARD CRASH
  if(multiplier >= crash){
    end(false);
    return;
  }

  requestAnimationFrame(loop);
}

/* MANUAL SHIFT */
shiftBtn.onclick = ()=>{
  if(!running) return;
  end(true);
};

/* END */
async function end(win){
  running = false;
  startBtn.disabled = false;
  shiftBtn.disabled = true;
  startBtn.classList.remove("running");

  if(win){
    const amt = bet * multiplier;
    balance += amt;
    await updateDoc(doc(db,"users",docId),{balance});
    walletEl.innerText = balance.toFixed(2);

    history.unshift(`WIN â‚¹${amt.toFixed(2)} @ ${multiplier.toFixed(2)}x`);
    statusEl.innerText = "ðŸŽ‰ You Win";
  }else{
    history.unshift(`LOSS â‚¹${bet}`);
    statusEl.innerText = "ðŸ’¥ Crashed";
  }

  history = history.slice(0,10);
  localStorage.setItem("FS_HISTORY", JSON.stringify(history));
  renderHistory();
}

/* RENDER HISTORY */
function renderHistory(){
  betsEl.innerHTML = history.length
    ? history.map(h=>`<div class="bet-row ${h.startsWith("WIN")?"win":"lose"}">${h}</div>`).join("")
    : "No bets yet";
}
</script>

</body>
</html>
