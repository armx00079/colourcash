<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dragon Tower</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(180deg,#020617,#0b1220);
  color:#fff;
  text-align:center;
}
.header{padding:14px;font-size:20px;font-weight:bold}
.wallet{
  position:fixed;top:12px;right:12px;
  background:#000;padding:8px 14px;
  border-radius:20px;font-weight:bold
}
.multi{margin:6px 0 10px;font-size:16px;font-weight:bold}
.tower{
  width:240px;margin:0 auto;
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px
}
.box{
  height:52px;border-radius:10px;
  background:#1f2937;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;cursor:pointer
}
.safe{background:#22c55e;color:#000}
.bomb{background:#dc2626}
.cashout{
  margin:14px auto 8px;
  width:90%;max-width:320px;
  background:#22c55e;color:#000;
  padding:12px;border-radius:26px;
  font-weight:bold;cursor:pointer
}
.bet-row{display:flex;justify-content:center;gap:10px;margin-bottom:6px}
.bet-btn{
  background:#000;color:#fff;
  padding:8px 14px;border-radius:18px;
  cursor:pointer;font-weight:bold
}
.mode-btn{
  margin:6px auto 12px;
  width:140px;background:#111827;
  padding:8px;border-radius:18px;cursor:pointer
}
.mode-popup{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
.mode-box{
  background:#020617;padding:20px;
  border-radius:16px;width:220px
}
.mode-item{
  padding:10px;border-radius:12px;
  margin:6px 0;background:#1f2937;
  cursor:pointer
}
.mode-item.active{background:#22c55e;color:#000}
.popup{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
.popup div{
  background:#111827;padding:24px 40px;
  border-radius:16px;font-size:22px;font-weight:bold
}
.win{color:#22c55e}
.loss{color:#dc2626}
</style>
</head>

<body>

<div class="header">üêâ DRAGON TOWER</div>
<div class="wallet">üí∞ ‚Çπ<span id="bal">0</span></div>

<div class="multi">Multiplier: <span id="multi">1.12x</span></div>

<div class="tower" id="tower"></div>

<div class="bet-row">
 <div class="bet-btn" id="minus">-</div>
 <div class="bet-btn" id="betText">Bet ‚Çπ10</div>
 <div class="bet-btn" id="plus">+</div>
</div>

<div class="cashout" id="cashout">CASHOUT</div>
<div class="mode-btn" id="modeBtn">Easy ‚ñæ</div>

<div class="mode-popup" id="modePopup">
 <div class="mode-box">
  <div class="mode-item active" data-m="easy">Easy</div>
  <div class="mode-item" data-m="medium">Medium</div>
  <div class="mode-item" data-m="hard">Hard</div>
  <div class="mode-item" data-m="expert">Expert</div>
  <div class="mode-item" data-m="master">Master</div>
 </div>
</div>

<div class="popup" id="popup"><div id="popupText"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• FIREBASE (SAME CONFIG ALWAYS) */
const app=initializeApp({
 apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
 authDomain:"colourcash-ea60e.firebaseapp.com",
 projectId:"colourcash-ea60e",
 storageBucket:"colourcash-ea60e.firebasestorage.app",
 messagingSenderId:"403688058646",
 appId:"1:403688058646:web:f1753360471528f275ea37"
});
const db=getFirestore(app);

/* WALLET */
const email=localStorage.getItem("userEmail");
let uid="", balance=0;
const bal=document.getElementById("bal");

async function loadWallet(){
 const q=query(collection(db,"users"),where("email","==",email));
 const s=await getDocs(q);
 s.forEach(d=>{uid=d.id;balance=+d.data().balance||0});
 bal.innerText=balance;
}
loadWallet();

/* GAME CONFIG */
const cfg={
 easy:{bombs:1,m:[1.12,1.28,1.50,1.85,2.30]},
 medium:{bombs:1,m:[1.25,1.55,2.00,2.80,4.00]},
 hard:{bombs:2,m:[1.60,2.30,3.50,6.00,10]},
 expert:{bombs:2,m:[2.00,3.50,6.50,12,25]},
 master:{bombs:3,m:[3.00,6.00,15,40,120]}
};

let mode="easy", step=0, bet=10, open=true;
const tower=document.getElementById("tower");
const multi=document.getElementById("multi");

function build(){
 tower.innerHTML="";
 for(let r=0;r<5;r++){
  let arr=[
   ...Array(3-cfg[mode].bombs).fill("safe"),
   ...Array(cfg[mode].bombs).fill("bomb")
  ].sort(()=>Math.random()-.5);

  arr.forEach(t=>{
   const d=document.createElement("div");
   d.className="box";
   d.onclick=()=>openBox(d,t,r);
   tower.appendChild(d);
  });
 }
 multi.innerText=cfg[mode].m[step].toFixed(2)+"x";
}
build();

async function openBox(el,type,row){
 if(row!==step||!open||balance<bet)return;
 open=false;

 balance-=bet;
 bal.innerText=balance;
 await updateDoc(doc(db,"users",uid),{balance});

 el.classList.add(type);
 el.innerText=type==="safe"?"üíé":"üêâ";

 if(type==="safe"){
  step++;
  if(step>=5){cashout.click();return;}
  multi.innerText=cfg[mode].m[step].toFixed(2)+"x";
  open=true;
 }else{
  show("YOU LOSE",false);
  reset();
 }
}

/* CASHOUT */
cashout.onclick=async ()=>{
 if(step===0)return;
 const win=Math.floor(bet*cfg[mode].m[step-1]);
 balance+=win;
 bal.innerText=balance;
 await updateDoc(doc(db,"users",uid),{balance});
 show("YOU WIN ‚Çπ"+win,true);
 reset();
};

function reset(){
 step=0;open=true;
 setTimeout(build,400);
}

/* BET */
minus.onclick=()=>{if(bet>10){bet-=10;betText.innerText="Bet ‚Çπ"+bet}}
plus.onclick=()=>{bet+=10;betText.innerText="Bet ‚Çπ"+bet}

/* MODE */
modeBtn.onclick=()=>modePopup.style.display="flex";
modePopup.onclick=()=>modePopup.style.display="none";
document.querySelectorAll(".mode-item").forEach(i=>{
 i.onclick=e=>{
  e.stopPropagation();
  document.querySelectorAll(".mode-item").forEach(x=>x.classList.remove("active"));
  i.classList.add("active");
  mode=i.dataset.m;
  modeBtn.innerText=i.innerText+" ‚ñæ";
  reset();
  modePopup.style.display="none";
 };
});

/* POPUP */
function show(t,w){
 popup.style.display="flex";
 popupText.className=w?"win":"loss";
 popupText.innerText=t;
 setTimeout(()=>popup.style.display="none",1800);
}
</script>

</body>
</html>
