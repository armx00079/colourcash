<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GANESH SLOTS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:url("images/bg/bg-main.jpg") center/cover no-repeat,
             radial-gradient(circle,#3b0a0a,#140404);
  color:#fff;
  text-align:center;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  font-weight:bold;
}
.wallet{
  background:rgba(0,0,0,.5);
  padding:6px 14px;
  border-radius:20px;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  padding:20px;
}
.cell{
  background:rgba(0,0,0,.55);
  border-radius:16px;
  height:90px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.cell img{
  max-width:70px;
  max-height:70px;
}

/* BET */
.bet-box{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-top:10px;
}
.bet-box button{
  width:44px;
  height:44px;
  border-radius:50%;
  border:none;
  font-size:22px;
  font-weight:bold;
  cursor:pointer;
}

/* SPIN */
.spin-btn{
  margin:16px auto;
  width:180px;
  padding:14px;
  border-radius:40px;
  background:linear-gradient(135deg,#ff9800,#ff5722);
  font-size:22px;
  font-weight:bold;
  color:#fff;
  border:none;
  cursor:pointer;
}

/* HISTORY */
.history{
  margin:16px;
  background:rgba(0,0,0,.4);
  border-radius:12px;
  padding:10px;
  font-size:13px;
}
.h-row{
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.15);
  padding:6px 0;
}
.win{color:#4caf50}
.lose{color:#ff5252}
.free{color:#ffeb3b}
</style>
</head>

<body>

<div class="header">
  <div>üïâÔ∏è GANESH SLOTS</div>
  <div class="wallet">‚Çπ <span id="wallet">0</span></div>
</div>

<div class="grid" id="grid"></div>

<div>3 Scatter = üéÅ 10 Free Spins</div>

<div class="bet-box">
  <button id="minusBtn">‚àí</button>
  Bet: ‚Çπ <span id="bet">10</span>
  <button id="plusBtn">+</button>
</div>

<button class="spin-btn" id="spinBtn">SPIN</button>

<div class="history">
  <h3>MY BETS</h3>
  <div id="history"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, getDocs, collection, query, where, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db=getFirestore(app);

const email=localStorage.getItem("userEmail");
let uid="", balance=0;

/* SYMBOLS */
const symbols=[
 {n:"diya",i:"images/symbols/diya.png"},
 {n:"flower",i:"images/symbols/flower.png"},
 {n:"coin",i:"images/symbols/coin.png"},
 {n:"wild",i:"images/symbols/wild.png"},
 {n:"scatter",i:"images/symbols/scatter.png"}
];

let bet=10;
let spinCount=0, winCount=0;
let freeSpins=0;

/* ELEMENTS */
const grid=document.getElementById("grid");
const walletEl=document.getElementById("wallet");
const betEl=document.getElementById("bet");
const historyBox=document.getElementById("history");
const spinBtn=document.getElementById("spinBtn");
const plusBtn=document.getElementById("plusBtn");
const minusBtn=document.getElementById("minusBtn");

/* GRID */
function buildGrid(res=null){
 grid.innerHTML="";
 for(let i=0;i<9;i++){
  const s=res?res[i]:null;
  const d=document.createElement("div");
  d.className="cell";
  if(s){
    const img=document.createElement("img");
    img.src=s.i;
    d.appendChild(img);
  }
  grid.appendChild(d);
 }
}

/* LOAD WALLET */
async function loadWallet(){
 const q=query(collection(db,"users"),where("email","==",email));
 const snap=await getDocs(q);
 snap.forEach(d=>{
  uid=d.id;
  balance=Number(d.data().balance||0);
 });
 walletEl.innerText=balance;
}
function userRef(){return doc(db,"users",uid);}

/* BET BUTTONS */
plusBtn.addEventListener("click",()=>{
 bet+=10;
 betEl.innerText=bet;
});
minusBtn.addEventListener("click",()=>{
 bet=Math.max(10,bet-10);
 betEl.innerText=bet;
});

/* WIN CONTROL */
function allowWin(){
 spinCount++;
 if(spinCount>10){spinCount=1;winCount=0;}
 if(winCount>=4) return false;

 let risk=bet/Math.max(balance,1);
 let chance=0.35;
 if(risk>0.3) chance=0.22;
 if(risk>0.5) chance=0.12;

 const w=Math.random()<chance;
 if(w) winCount++;
 return w;
}

/* SPIN */
spinBtn.addEventListener("click", async ()=>{
 if(freeSpins<=0){
  if(balance<bet) return alert("Low balance");
  balance-=bet;
  await updateDoc(userRef(),{balance});
 }
 walletEl.innerText=balance;

 let result=[];
 for(let i=0;i<9;i++){
  let s=Math.random()<0.04?symbols[4]:symbols[Math.floor(Math.random()*4)];
  result.push(s);
 }
 buildGrid(result);

 const scat=result.filter(x=>x.n==="scatter").length;
 const wild=result.filter(x=>x.n==="wild").length;

 let win=false,winAmt=0;

 if(scat>=3 && freeSpins===0){
  freeSpins=10;
  addHistory("FREE SPINS",10,"free");
 }
 else if(wild>=3 && allowWin()){
  win=true;
  winAmt=bet*(1+wild);
 }

 if(win){
  balance+=winAmt;
  await updateDoc(userRef(),{balance});
 }

 if(freeSpins>0) freeSpins--;

 walletEl.innerText=balance;
 addHistory(win?"WIN":"LOSE", win?winAmt:bet, win?"win":"lose");
});

/* HISTORY */
function addHistory(t,amt,cls){
 const r=document.createElement("div");
 r.className="h-row";
 r.innerHTML=`<span>${t}</span><span class="${cls}">
 ${t==="LOSE"?"-":"+"}‚Çπ${amt}</span>`;
 historyBox.prepend(r);
}

/* START */
buildGrid();
loadWallet();
</script>

</body>
</html>
