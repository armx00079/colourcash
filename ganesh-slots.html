<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GANESH SLOTS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:url("images/bg/bg-main.jpg") center/cover no-repeat;
  color:#fff;
  text-align:center;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  font-weight:bold;
}
.wallet{
  background:rgba(0,0,0,.5);
  padding:6px 14px;
  border-radius:20px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  padding:20px;
}
.cell{
  background:rgba(0,0,0,.45);
  border-radius:14px;
  height:90px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.cell img{
  max-width:70px;
}
.bet-box{
  margin-top:10px;
}
.bet-box button{
  width:40px;height:40px;border-radius:50%;
  border:none;font-size:20px;
}
.spin-btn{
  margin-top:14px;
}
.spin-btn img{
  width:90px;
}
.spin-btn button{
  padding:14px 40px;
  font-size:22px;
  border:none;
  border-radius:40px;
  background:#ff9800;
  font-weight:bold;
}
.history{
  margin:16px;
  background:rgba(0,0,0,.4);
  border-radius:12px;
  padding:10px;
  font-size:13px;
}
.h-row{
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.15);
  padding:6px 0;
}
.win{color:#4caf50}
.lose{color:#ff5252}
</style>
</head>

<body>

<div class="header">
  <div>üïâÔ∏è GANESH SLOTS</div>
  <div class="wallet">‚Çπ <span id="wallet">0</span></div>
</div>

<div class="grid" id="grid"></div>

<div>3 Wild = Multiplier Boost</div>

<div class="bet-box">
  <button onclick="changeBet(-10)">‚àí</button>
  Bet: ‚Çπ <span id="bet">10</span>
  <button onclick="changeBet(10)">+</button>
</div>

<div class="spin-btn">
  <img src="images/ui/spin.png" onerror="this.style.display='none';document.getElementById('spinText').style.display='inline-block'">
  <button id="spinText" style="display:none" onclick="spin()">SPIN</button>
</div>

<div class="history">
  <h3>MY BETS</h3>
  <div id="history"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, getDocs, collection, query, where,
  doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db = getFirestore(app);

const email = localStorage.getItem("userEmail");
let uid="", balance=0;

/* SYMBOLS */
const symbols=[
 {name:"diya", img:"images/symbols/diya.png"},
 {name:"flower", img:"images/symbols/flower.png"},
 {name:"coin", img:"images/symbols/coin.png"},
 {name:"wild", img:"images/symbols/wild.png"},
 {name:"scatter", img:"images/symbols/scatter.png"}
];

let bet=10;
let spinCount=0;
let winInCycle=0;

/* UI */
const grid=document.getElementById("grid");
const walletEl=document.getElementById("wallet");
const betEl=document.getElementById("bet");
const historyBox=document.getElementById("history");

/* LOAD WALLET */
async function loadWallet(){
 const q=query(collection(db,"users"),where("email","==",email));
 const snap=await getDocs(q);
 snap.forEach(d=>{
  uid=d.id;
  balance=Number(d.data().balance||0);
 });
 walletEl.innerText=balance;
}
function userRef(){return doc(db,"users",uid);}

/* BET */
function changeBet(v){
 bet=Math.max(10,bet+v);
 betEl.innerText=bet;
}

/* RISK + WIN LOGIC */
function shouldWin(){
 spinCount++;
 if(spinCount>10){spinCount=1;winInCycle=0;}

 let maxWins=3+Math.floor(Math.random()*2); // 3‚Äì4
 if(winInCycle>=maxWins) return false;

 let risk=bet/balance;
 let chance=0.4;
 if(risk>0.3) chance=0.22;
 if(risk>0.5) chance=0.12;

 const win=Math.random()<chance;
 if(win) winInCycle++;
 return win;
}

/* SPIN */
async function spin(){
 if(balance<bet)return alert("Low balance");

 balance-=bet;
 await updateDoc(userRef(),{balance});
 walletEl.innerText=balance;

 grid.innerHTML="";
 let result=[];
 for(let i=0;i<9;i++){
  let s;
  if(Math.random()<0.06) s=symbols[4]; // scatter rare
  else s=symbols[Math.floor(Math.random()*4)];
  result.push(s);
  grid.innerHTML+=`<div class="cell"><img src="${s.img}"></div>`;
 }

 let win=false, winAmt=0;
 const wilds=result.filter(x=>x.name==="wild").length;
 const scatters=result.filter(x=>x.name==="scatter").length;

 if(scatters>=3){ win=true; winAmt=bet*5; }
 else if(wilds>=3 && shouldWin()){ win=true; winAmt=bet*(1+wilds); }

 if(win){
  balance+=winAmt;
  await updateDoc(userRef(),{balance});
 }

 walletEl.innerText=balance;
 addHistory(win, win?winAmt:bet);
}

/* HISTORY */
async function addHistory(win,amt){
 const row=document.createElement("div");
 row.className="h-row";
 row.innerHTML=`<span>${win?"WIN":"LOSE"}</span>
 <span class="${win?"win":"lose"}">${win?"+":"-"}‚Çπ${amt}</span>`;
 historyBox.prepend(row);
}

loadWallet();
</script>

</body>
</html>
