<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üêé Horse Race</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#1b5e20;color:#fff}
.stage{
  background:url("images/bg/sky.png") top/cover no-repeat,
             url("images/bg/grass.png") bottom/cover no-repeat;
  min-height:100vh;
}

/* HEADER */
.header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 14px;font-size:20px;font-weight:bold
}
.wallet{
  background:rgba(0,0,0,.35);
  padding:6px 14px;border-radius:20px
}

/* HISTORY */
.history{
  display:flex;justify-content:center;gap:6px;padding-top:8px
}
.ball{
  width:26px;height:26px;border-radius:50%;
  background:#ff9800;color:#000;
  text-align:center;line-height:26px;
  font-size:14px;font-weight:bold
}

/* TIMER */
.timer-box{
  display:flex;justify-content:center;align-items:center;
  font-size:22px;font-weight:bold;margin-top:4px
}
.timer-box img{width:30px;margin-right:6px}
.bet-close{text-align:center;color:#ffeb3b;font-size:14px;height:18px}

/* BET PANEL */
.bet-panel{
  display:grid;grid-template-columns:repeat(2,1fr);
  gap:10px;padding:10px
}
.horse-card{
  background:#0f8a70;border-radius:10px;padding:8px;
  display:flex;align-items:center;gap:8px;
  position:relative;cursor:pointer
}
.horse-card.active{outline:3px solid gold}
.horse-card img{width:46px}
.bet-badge{
  position:absolute;top:-6px;right:-6px;
  background:#ffeb3b;color:#000;
  padding:2px 6px;border-radius:12px;
  font-size:12px;font-weight:bold
}

/* TRACK */
.track{margin:10px}
.lane{
  height:42px;position:relative;
  border-bottom:2px solid rgba(255,255,255,.35);
  background:rgba(139,69,19,.25);
  margin-bottom:6px
}
.lane img{
  width:36px;position:absolute;left:0;bottom:2px;
  transition:left .08s linear
}

/* CHIPS */
.chips{display:flex;justify-content:center;gap:10px;padding:10px}
.chip{
  background:#fff;color:#000;padding:10px;
  border-radius:50%;font-weight:bold;cursor:pointer
}
.chip.active{background:gold}

/* POPUP */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:99
}
.popup{padding:22px 28px;border-radius:16px;text-align:center}
.popup.win{background:#2e7d32}
.popup.lose{background:#b71c1c}
</style>
</head>

<body>
<div class="stage">

<div class="header">
 üêé Horse Race
 <div class="wallet">‚Çπ <span id="wallet">0</span></div>
</div>

<div class="history" id="history"></div>

<div class="timer-box">
 <img src="images/ui/timer.png">
 <span id="time">15</span>s
</div>
<div class="bet-close" id="betClose"></div>

<div class="bet-panel" id="betPanel"></div>
<div class="track" id="track"></div>

<div class="chips">
 <div class="chip" data-amt="10">10</div>
 <div class="chip" data-amt="50">50</div>
 <div class="chip" data-amt="100">100</div>
 <div class="chip" data-amt="500">500</div>
</div>

</div>

<div class="overlay" id="overlay">
 <div class="popup" id="popup"><h2 id="popupText"></h2></div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain: "colourcash-ea60e.firebaseapp.com",
  projectId: "colourcash-ea60e",
  storageBucket: "colourcash-ea60e.firebasestorage.app",
  messagingSenderId: "403688058646",
  appId: "1:403688058646:web:f1753360471528f275ea37"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* USER */
const userId = localStorage.getItem("userId") || "demo_user";
const userRef = doc(db,"users",userId);

/* DATA */
const horses=[
 {id:1,odds:8.6},{id:2,odds:6.5},{id:3,odds:4.7},
 {id:4,odds:6.8},{id:5,odds:9.7},{id:6,odds:3.9}
];

let balance=0;
let selectedChip=0;
let horseBets={};
let betting=true;
let time=15;
let timerInterval=null;

/* ELEMENTS */
const walletEl=document.getElementById("wallet");
const timeEl=document.getElementById("time");
const betClose=document.getElementById("betClose");
const betPanel=document.getElementById("betPanel");
const track=document.getElementById("track");
const historyEl=document.getElementById("history");
const overlay=document.getElementById("overlay");
const popup=document.getElementById("popup");
const popupText=document.getElementById("popupText");

/* WALLET LOAD (PLINKO STYLE FIX) */
async function loadWallet(){
 const snap = await getDoc(userRef);
 if(snap.exists()){
  balance = snap.data().balance || 0;
 }else{
  balance = 1000;
  await setDoc(userRef,{balance});
 }
 walletEl.innerText = balance;
}

/* HISTORY PERSIST */
let history = JSON.parse(localStorage.getItem("raceHistory")||"[]");
renderHistory();

function renderHistory(){
 historyEl.innerHTML = history.map(n=>`<div class="ball">${n}</div>`).join("");
}
function pushHistory(id){
 history.unshift(id);
 history=history.slice(0,10);
 localStorage.setItem("raceHistory",JSON.stringify(history));
 renderHistory();
}

/* BUILD ROUND */
function buildRound(){
 betPanel.innerHTML="";
 track.innerHTML="";
 horseBets={};
 betting=true;
 betClose.innerText="";
 time=15;
 timeEl.innerText=time;

 horses.forEach(h=>{
  horseBets[h.id]=0;

  const card=document.createElement("div");
  card.className="horse-card";
  card.innerHTML=`
    <img src="images/horses/horse${h.id}.png">
    <div><b>Horse ${h.id}</b><div>Odds ${h.odds}</div></div>
  `;
  card.onclick=async()=>{
   if(!betting || !selectedChip) return;
   if(balance < selectedChip) return alert("Low Balance");

   balance -= selectedChip;
   horseBets[h.id]+=selectedChip;
   await updateDoc(userRef,{balance});
   walletEl.innerText=balance;

   let badge=card.querySelector(".bet-badge");
   if(!badge){
    badge=document.createElement("div");
    badge.className="bet-badge";
    card.appendChild(badge);
   }
   badge.innerText="‚Çπ"+horseBets[h.id];
  };
  betPanel.appendChild(card);

  const lane=document.createElement("div");
  lane.className="lane";
  lane.innerHTML=`<img id="horse${h.id}" src="images/horses/horse${h.id}.png">`;
  track.appendChild(lane);
 });
}

/* CHIPS */
document.querySelectorAll(".chip").forEach(c=>{
 c.onclick=()=>{
  document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
  c.classList.add("active");
  selectedChip=+c.dataset.amt;
 };
});

/* TIMER (REFRESH FIXED) */
function startTimer(){
 clearInterval(timerInterval);
 timerInterval=setInterval(()=>{
  time--;
  timeEl.innerText=time;
  if(time<=3){betting=false;betClose.innerText="Bet Closed";}
  if(time<=0){clearInterval(timerInterval);startRace();}
 },1000);
}

/* RISK LOGIC */
function winChance(totalBet){
 if(totalBet<=100) return 0.45;
 if(totalBet<=300) return 0.30;
 if(totalBet<=700) return 0.18;
 return 0.10;
}

/* RACE */
function startRace(){
 let pos={};horses.forEach(h=>pos[h.id]=0);
 let totalBet=Object.values(horseBets).reduce((a,b)=>a+b,0);
 let betIds=Object.keys(horseBets).filter(i=>horseBets[i]>0).map(Number);

 let shouldWin = betIds.length && Math.random()<winChance(totalBet);
 let winningHorse = shouldWin
   ? betIds[Math.floor(Math.random()*betIds.length)]
   : horses[Math.floor(Math.random()*horses.length)].id;

 const race=setInterval(()=>{
  horses.forEach(h=>{
   let speed=Math.random()*3;
   if(h.id===winningHorse) speed+=1.8;
   pos[h.id]+=speed;
   document.getElementById("horse"+h.id).style.left=pos[h.id]+"%";
   if(pos[h.id]>=90){clearInterval(race);finishRace(h.id);}
  });
 },60);
}

/* FINISH */
async function finishRace(winId){
 pushHistory(winId);
 overlay.style.display="flex";

 let horse=horses.find(h=>h.id===winId);
 let winAmount=(horseBets[winId]||0)*horse.odds;

 if(winAmount>0){
  balance+=winAmount;
  popup.className="popup win";
  popupText.innerText="üéâ You Win ‚Çπ"+winAmount.toFixed(2);
 }else{
  popup.className="popup lose";
  popupText.innerText="‚ùå You Lose";
 }

 await updateDoc(userRef,{balance});
 walletEl.innerText=balance;

 setTimeout(()=>{
  overlay.style.display="none";
  buildRound();
  startTimer();
 },2000);
}

/* START */
await loadWallet();
buildRound();
startTimer();
</script>
</body>
</html>
