<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üêé Horse Race</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#1b5e20;color:#fff}
.stage{
  background:url("images/bg/sky.png") top/cover no-repeat,
             url("images/bg/grass.png") bottom/cover no-repeat;
  min-height:100vh;
}
.header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 14px;font-size:20px;font-weight:bold
}
.wallet{background:rgba(0,0,0,.35);padding:6px 14px;border-radius:20px}

.history{display:flex;justify-content:center;gap:6px;padding-top:8px}
.ball{
  width:26px;height:26px;border-radius:50%;
  background:#ff9800;color:#000;
  text-align:center;line-height:26px;font-weight:bold
}

.timer-box{
  display:flex;justify-content:center;align-items:center;
  font-size:22px;font-weight:bold;margin-top:4px
}
.timer-box img{width:30px;margin-right:6px}
.bet-close{text-align:center;color:#ffeb3b;font-size:14px;height:18px}

.bet-panel{
  display:grid;grid-template-columns:repeat(2,1fr);
  gap:10px;padding:10px
}
.horse-card{
  background:#0f8a70;border-radius:10px;padding:8px;
  display:flex;align-items:center;gap:8px;
  position:relative;cursor:pointer
}
.horse-card.active{outline:3px solid gold}
.horse-card img{width:46px}
.bet-badge{
  position:absolute;top:-6px;right:-6px;
  background:#ffeb3b;color:#000;
  padding:2px 6px;border-radius:12px;
  font-size:12px;font-weight:bold
}

.track{margin:10px}
.lane{
  height:42px;position:relative;
  border-bottom:2px solid rgba(255,255,255,.35);
  background:rgba(139,69,19,.25);
  margin-bottom:6px
}
.lane img{
  width:36px;position:absolute;left:0;bottom:2px;
  transition:left .08s linear
}

.chips{
  display:flex;justify-content:center;gap:10px;padding:12px
}
.chip{
  width:52px;height:52px;border-radius:50%;
  background:radial-gradient(circle,#fff,#d4af37,#8a6a00);
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;color:#000;cursor:pointer
}
.chip.active{outline:3px solid gold}

.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:99
}
.popup{padding:22px 28px;border-radius:16px;text-align:center}
.popup.win{background:#2e7d32}
.popup.lose{background:#b71c1c}
</style>
</head>

<body>
<div class="stage">

<div class="header">
 üêé Horse Race
 <div class="wallet">‚Çπ <span id="wallet">0</span></div>
</div>

<div class="history" id="history"></div>

<div class="timer-box">
 <img src="images/ui/timer.png">
 <span id="time">0</span>s
</div>
<div class="bet-close" id="betClose"></div>

<div class="bet-panel" id="betPanel"></div>
<div class="track" id="track"></div>

<div class="chips">
 <div class="chip" data-amt="10">10</div>
 <div class="chip" data-amt="50">50</div>
 <div class="chip" data-amt="100">100</div>
 <div class="chip" data-amt="500">500</div>
</div>

</div>

<div class="overlay" id="overlay">
 <div class="popup" id="popup"><h2 id="popupText"></h2></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, getDocs, collection, query, where,
  doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db = getFirestore(app);

/* USER */
const userEmail = localStorage.getItem("userEmail");
let uid="", balance=0;

/* DOM FIX (üî• IMPORTANT) */
const walletEl = document.getElementById("wallet");
const timeEl = document.getElementById("time");
const betCloseEl = document.getElementById("betClose");
const historyEl = document.getElementById("history");
const betPanel = document.getElementById("betPanel");
const track = document.getElementById("track");
const overlay = document.getElementById("overlay");
const popup = document.getElementById("popup");
const popupText = document.getElementById("popupText");

/* GAME DATA */
const horses=[
 {id:1,odds:8.6},{id:2,odds:6.5},{id:3,odds:4.7},
 {id:4,odds:6.8},{id:5,odds:9.7},{id:6,odds:3.9}
];

let selectedChip=0, betting=true;
let horseBets={}, timerInt=null;
const ROUND_TIME=15000;

/* LOAD WALLET */
async function loadWallet(){
 const q=query(collection(db,"users"),where("email","==",userEmail));
 const snap=await getDocs(q);
 snap.forEach(d=>{
  uid=d.id;
  balance=Number(d.data().balance||0);
 });
 walletEl.innerText=balance;
}
function userRef(){ return doc(db,"users",uid); }

/* LOAD HISTORY */
async function loadHistory(){
 const snap=await getDoc(userRef());
 const h=snap.data()?.horseHistory||[];
 historyEl.innerHTML=h.map(n=>`<div class="ball">${n}</div>`).join("");
}

/* TIMER */
async function syncTimer(){
 const snap=await getDoc(userRef());
 let start=snap.data().roundStart;
 if(!start){
  start=Date.now();
  await updateDoc(userRef(),{roundStart:start});
 }
 clearInterval(timerInt);
 timerInt=setInterval(()=>{
  const left=ROUND_TIME-(Date.now()-start);
  const sec=Math.max(0,Math.ceil(left/1000));
  timeEl.innerText=sec;
  if(sec<=3){betting=false;betCloseEl.innerText="Bet Closed";}
  if(sec<=0){clearInterval(timerInt);startRace();}
 },500);
}

/* BUILD UI */
function buildUI(){
 betPanel.innerHTML="";track.innerHTML="";
 horseBets={};betting=true;betCloseEl.innerText="";
 horses.forEach(h=>{
  horseBets[h.id]=0;
  const c=document.createElement("div");
  c.className="horse-card";
  c.innerHTML=`<img src="images/horses/horse${h.id}.png">
  <div><b>Horse ${h.id}</b><div>Odds ${h.odds}</div></div>`;
  c.onclick=async()=>{
   if(!betting||!selectedChip||balance<selectedChip)return;
   balance-=selectedChip;
   horseBets[h.id]+=selectedChip;
   walletEl.innerText=balance;
   await updateDoc(userRef(),{balance});
   let b=c.querySelector(".bet-badge")||c.appendChild(document.createElement("div"));
   b.className="bet-badge";b.innerText="‚Çπ"+horseBets[h.id];
  };
  betPanel.appendChild(c);

  const l=document.createElement("div");
  l.className="lane";
  l.innerHTML=`<img id="horse${h.id}" src="images/horses/horse${h.id}.png">`;
  track.appendChild(l);
 });
}

/* RACE */
function startRace(){
 let pos={};horses.forEach(h=>pos[h.id]=0);
 const race=setInterval(()=>{
  horses.forEach(h=>{
   pos[h.id]+=Math.random()*3;
   document.getElementById("horse"+h.id).style.left=pos[h.id]+"%";
   if(pos[h.id]>=90){clearInterval(race);finish(h.id);}
  });
 },60);
}

/* FINISH */
async function finish(win){
 overlay.style.display="flex";
 const bet=horseBets[win]||0;
 if(bet){
  const w=bet*horses.find(h=>h.id===win).odds;
  balance+=w;
  popup.className="popup win";
  popupText.innerText="üéâ You Win ‚Çπ"+w.toFixed(2);
 }else{
  popup.className="popup lose";
  popupText.innerText="‚ùå You Lose";
 }

 const snap=await getDoc(userRef());
 let h=snap.data().horseHistory||[];
 h.unshift(win);h=h.slice(0,10);

 await updateDoc(userRef(),{
  balance,
  horseHistory:h,
  roundStart:Date.now()
 });

 walletEl.innerText=balance;
 historyEl.innerHTML=h.map(n=>`<div class="ball">${n}</div>`).join("");

 setTimeout(()=>{
  overlay.style.display="none";
  buildUI();
  syncTimer();
 },2000);
}

/* CHIPS */
document.querySelectorAll(".chip").forEach(c=>{
 c.onclick=()=>{
  document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
  c.classList.add("active");
  selectedChip=+c.dataset.amt;
 };
});

/* START */
await loadWallet();
await loadHistory();
buildUI();
syncTimer();
</script>
</body>
</html>
