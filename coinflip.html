<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Coin Flip</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#081c2f;color:#fff}
.header{display:flex;justify-content:space-between;align-items:center;padding:14px;background:#041425}
.balance{font-size:18px;color:#00e676;font-weight:bold}
.title{font-size:20px}

.history{
  display:flex;gap:8px;padding:10px;
  overflow-x:auto;background:#061a2f
}
.history span{
  padding:6px 10px;
  border-radius:20px;
  font-size:14px;
  background:#0e2a44
}

.game{
  height:45vh;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.coin{
  width:140px;height:140px;
  border-radius:50%;
  background:radial-gradient(circle,#ffd54f,#f9a825);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  font-weight:bold;
  color:#000;
  transition:transform 1s;
}

.flip{animation:spin 1s linear}
@keyframes spin{from{transform:rotateY(0deg)}to{transform:rotateY(720deg)}}

.controls{padding:15px;background:#041425}
.betrow{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.betrow button{width:40px;height:40px;border:none;border-radius:10px;background:#123a5c;color:#fff;font-size:18px}
.betrow input{flex:1;padding:10px;border:none;border-radius:10px;font-size:18px;text-align:center}

.action{display:flex;gap:12px}
.action button{flex:1;padding:14px;border:none;border-radius:12px;font-size:18px;font-weight:bold;color:#fff}
.head{background:#2ecc71}
.tail{background:#3498db}

.popup-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99}
.popup{background:#0b2a45;padding:20px 26px;border-radius:14px;font-size:20px;font-weight:bold}
.win{color:#2ecc71}
.loss{color:#ff5252}

/* NEW */
.mybets{padding:12px;background:#041425}
.mybets h3{margin:0 0 8px;font-size:16px}
.mybets div{font-size:14px;padding:6px;border-bottom:1px solid #123}
</style>
</head>

<body>

<div class="header">
  <div class="title">Coin Flip</div>
  <div class="balance">â‚¹ <span id="wallet">1000</span></div>
</div>

<div class="history" id="history"></div>

<div class="game">
  <div class="coin" id="coin">ðŸª™</div>
</div>

<div class="controls">
  <div class="betrow">
    <button onclick="chg(-1)">âˆ’</button>
    <input id="amt" value="10">
    <button onclick="chg(1)">+</button>
  </div>
  <div class="action">
    <button class="head" onclick="play('HEAD')">BET HEAD</button>
    <button class="tail" onclick="play('TAIL')">BET TAIL</button>
  </div>
</div>

<!-- ðŸ”¥ MY BETS HISTORY -->
<div class="mybets">
  <h3>My Bets</h3>
  <div id="mybets"></div>
</div>

<div class="popup-bg" id="popupBg">
  <div class="popup" id="popup"></div>
</div>

<script>
let wallet = +localStorage.getItem("coin_wallet") || 1000;
let history = JSON.parse(localStorage.getItem("coin_history")||"[]");
let bets = JSON.parse(localStorage.getItem("coin_bets")||"[]");
let COIN_EDGE = 0.5;
  
const walletEl = document.getElementById("wallet");
const coin = document.getElementById("coin");
const histEl = document.getElementById("history");
const betsEl = document.getElementById("mybets");
const popupBg = document.getElementById("popupBg");
const popup = document.getElementById("popup");

walletEl.innerText = wallet;
renderHistory();
renderBets();

function chg(v){
  let a=document.getElementById("amt");
  a.value=Math.max(1,+a.value+v);
}

function play(choice){
  let amt=+document.getElementById("amt").value;
  if(wallet<amt) return showPopup("Low Balance","loss");

  wallet-=amt;
  walletEl.innerText=wallet;
  saveWallet();

  coin.classList.add("flip");

  setTimeout(()=>{
    coin.classList.remove("flip");
    let result = decideCoinResult(choice);
    coin.innerText=result==="HEAD"?"ðŸ™‚":"ðŸª™";

    history.unshift(result);
    history=history.slice(0,10);
    renderHistory();
    saveHistory();

    let winAmt=0;
    let status="LOSS";
    if(result===choice){
      winAmt=amt*2;
      wallet+=winAmt;
      walletEl.innerText=wallet;
      saveWallet();
      status="WIN";
      showPopup("You Win â‚¹"+winAmt,"win");
    }else{
      showPopup("You Lose","loss");
    }

    bets.unshift({
      time:new Date().toLocaleTimeString(),
      choice,
      result,
      amt,
      status
    });
    bets=bets.slice(0,20);
    localStorage.setItem("coin_bets",JSON.stringify(bets));
    renderBets();
  },1000);
}

function renderHistory(){
  histEl.innerHTML="";
  history.forEach(h=>{
    let s=document.createElement("span");
    s.innerText=h==="HEAD"?"ðŸ™‚ HEAD":"ðŸª™ TAIL";
    histEl.appendChild(s);
  });
}

function renderBets(){
  betsEl.innerHTML="";
  bets.forEach(b=>{
    let d=document.createElement("div");
    d.innerText=`${b.time} | ${b.choice} | â‚¹${b.amt} | ${b.status}`;
    betsEl.appendChild(d);
  });
}

function showPopup(msg,type){
  popup.className="popup "+type;
  popup.innerText=msg;
  popupBg.style.display="flex";
  setTimeout(()=>popupBg.style.display="none",1500);
}

function saveWallet(){localStorage.setItem("coin_wallet",wallet);}
function saveHistory(){localStorage.setItem("coin_history",JSON.stringify(history));}
</script>

<!-- FIREBASE WALLET CONNECT (ADDITION ONLY) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBx3J9aGn_98rTPgurMMKw_GR3puIMj4Ms",
  authDomain:"colourcash-ea60e.firebaseapp.com",
  projectId:"colourcash-ea60e"
});
const db=getFirestore(app);
// ===== COIN EDGE =====
let COIN_EDGE = 0.5;

async function loadCoinEdge(){
  const ref = doc(db,"settings","houseEdge");
  const snap = await getDoc(ref);
  if(snap.exists()){
    COIN_EDGE = Number(snap.data().coinFlip);
    console.log("COIN EDGE =", COIN_EDGE);
  }
}

// ===== DECIDE RESULT =====
function decideCoinResult(userChoice){

  // ðŸ’¯ GUARANTEED LOSS
  if(COIN_EDGE === 0){
    return userChoice === "HEAD" ? "TAIL" : "HEAD";
  }

  // ðŸ’¯ GUARANTEED WIN
  if(COIN_EDGE === 1){
    return userChoice;
  }

  // ðŸŽ¯ PROBABILITY MODE
  return Math.random() < COIN_EDGE
    ? userChoice
    : (userChoice === "HEAD" ? "TAIL" : "HEAD");
}

// LOAD EDGE AFTER FIREBASE READY
await loadCoinEdge();
const email=localStorage.getItem("userEmail");
let uid="";
let lastWallet=wallet;

async function loadWallet(){
  if(!email) return;
  const q=query(collection(db,"users"),where("email","==",email));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    uid=d.id;
    wallet=d.data().balance||wallet;
    walletEl.innerText=wallet;
    localStorage.setItem("coin_wallet",wallet);
  });
}
loadWallet();

setInterval(async()=>{
  if(!uid) return;
  if(wallet!==lastWallet){
    lastWallet=wallet;
    await updateDoc(doc(db,"users",uid),{balance:wallet});
  }
},800);
</script>

</body>
</html>
